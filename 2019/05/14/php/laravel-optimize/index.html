<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
    <meta name="keywords" content="使用Swoole提升Laravel的性能, wyq php laravel linux python js go">
    <meta name="description" content="优化 Laravel 网站打开速度
关闭 debug打开.env 文件，把 debug 设置为 false. barryvdh/laravel-debugbar等开发环境使用的包一定要放在require-dev,线上就不要载入了，就算载入也">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>使用Swoole提升Laravel的性能 | WYQ</title>
    <link rel="icon" type="image/png" href="https://githubio.pek3b.qingstor.com/favicon.png">

    <link rel="stylesheet" type="text/css" href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.bootcss.com/materialize/1.0.0/css/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.bootcss.com/aos/2.3.4/aos.css">
    <link rel="stylesheet" type="text/css" href="https://githubio.pek3b.qingstor.com/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.bootcss.com/lightgallery/1.6.11/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="https://cdn.bootcss.com/jquery/2.2.0/jquery.min.js"></script>
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>


<body>

<header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="https://githubio.pek3b.qingstor.com/medias/avatar.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">WYQ</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right">
    
    <li class="hide-on-med-and-down">
        <a href="/" class="waves-effect waves-light">
            
            <i class="fa fa-home"></i>
            
            <span>首页</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/tags" class="waves-effect waves-light">
            
            <i class="fa fa-tags"></i>
            
            <span>标签</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories" class="waves-effect waves-light">
            
            <i class="fa fa-bookmark"></i>
            
            <span>分类</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/archives" class="waves-effect waves-light">
            
            <i class="fa fa-archive"></i>
            
            <span>归档</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/about" class="waves-effect waves-light">
            
            <i class="fa fa-user-circle-o"></i>
            
            <span>关于</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/friends" class="waves-effect waves-light">
            
            <i class="fa fa-address-book"></i>
            
            <span>友情链接</span>
        </a>
    </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="https://githubio.pek3b.qingstor.com/medias/avatar.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">WYQ</div>
        <div class="logo-desc">
            
            A phper&#39;s blog
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li>
            <a href="/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-home"></i>
                
                首页
            </a>
        </li>
        
        <li>
            <a href="/tags" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-tags"></i>
                
                标签
            </a>
        </li>
        
        <li>
            <a href="/categories" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-bookmark"></i>
                
                分类
            </a>
        </li>
        
        <li>
            <a href="/archives" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-archive"></i>
                
                归档
            </a>
        </li>
        
        <li>
            <a href="/about" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-user-circle-o"></i>
                
                关于
            </a>
        </li>
        
        <li>
            <a href="/friends" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-address-book"></i>
                
                友情链接
            </a>
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/yujiarong" class="waves-effect waves-light" target="_blank">
                <i class="fa fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>

        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/yujiarong" class="github-corner tooltipped hide-on-med-and-down" target="_blank" data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewbox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/>
    </svg>
</a>
        
    </nav>

</header>





<div class="bg-cover pd-header post-cover" style="background-image: url('https://githubio.pek3b.qingstor.com/medias/featureimages/14.jpg')">
    <div class="container">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        使用Swoole提升Laravel的性能
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<main class="post-container content">

    
    <link rel="stylesheet" href="https://cdn.bootcss.com/tocbot/4.7.0/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 20px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/laravel/" target="_blank">
                                <span class="chip bg-color">laravel</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/PHP/" class="post-category" target="_blank">
                                PHP
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2019-05-14
                </div>

                
				
				
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h3 id="优化-Laravel-网站打开速度"><a href="#优化-Laravel-网站打开速度" class="headerlink" title="优化 Laravel 网站打开速度"></a>优化 Laravel 网站打开速度</h3><ol>
<li>关闭 debug<br>打开.env 文件，把 debug 设置为 false. <code>barryvdh/laravel-debugbar</code>等开发环境使用的包一定要放在require-dev,线上就不要载入了，就算载入也要关闭。</li>
<li>缓存路由和配置<br>php artisan route:cache。如果路由中有闭包是会报错的,所以路由中就不要添加处理逻辑<br>php artisan config:cache</li>
<li>composer 优化<br>composer dump-autoload –optimize</li>
<li>Laravel 优化命令<br>php artisan optimize</li>
<li>使用 Laravel 缓存<pre class=" language-php"><code class="language-php"><span class="token variable">$lists</span> <span class="token operator">=</span> Cache<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">remember</span><span class="token punctuation">(</span><span class="token string">'key'</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">destination</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">getList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
</li>
<li><p>使用 PHP7 并开启 OPcache<br>开启opcache后需要重启 php-fpm哦</p>
</li>
<li><p>nginx 开启 gzip 压缩<br>Nginx 开启 gzip 可以有效减少服务器带宽的消耗，缺点是会增大 CPU 的占用率，但是很多时候 CPU 往往是空闲最多的。<br>在nginx的配置中添加如下:</p>
<pre class=" language-bash"><code class="language-bash"><span class="token function">gzip</span> on<span class="token punctuation">;</span>
gzip_min_length 1k<span class="token punctuation">;</span>
gzip_buffers 16 64k<span class="token punctuation">;</span>
gzip_http_version 1.1<span class="token punctuation">;</span>
gzip_comp_level 9<span class="token punctuation">;</span>
gzip_types text/plain application/x-javascript application/javascript text/css application/xml text/javascript application/x-httpd-php image/jpeg image/gif image/png font/ttf font/otf image/svg+xml<span class="token punctuation">;</span>
gzip_vary on<span class="token punctuation">;</span>   
</code></pre>
</li>
</ol>
<p><code>GZIP_MIN_LENGTH</code>  设置允许压缩的页面最小字节数，页面字节数从 header 头中的 Content-Length 中进行获取。默认值是 0，不管页面多大都压缩。建议设置成大于 1k 的字节数，小于 1k 可能会越压越大。 即: gzip_min_length 1024 </p>
<p>响应头中 Content-Encoding 字段是 gzip，表示该网页是经过 gzip 压缩的。</p>
<h3 id="使用swoole来laravel优化项目"><a href="#使用swoole来laravel优化项目" class="headerlink" title="使用swoole来laravel优化项目"></a>使用swoole来laravel优化项目</h3><p>我们这里使用<a href="https://github.com/hhxsv5/laravel-s" target="_blank" rel="noopener">laravels</a>来优化laravel5.5</p>
<ol>
<li>composer require “hhxsv5/laravel-s:~3.5.0” -vvv</li>
<li>配置ningx的代理到swoole端口。Nginx的配置,使用的是proxy_pass+upstream。</li>
<li>由于swoole是常驻内存，所以单例的写法和HTTP请求参数获取需要注意，下面会说。</li>
<li>如果某些包在加入swoole后出现了异常，可以用一个中间件来重置单例对象的状态。</li>
</ol>
<pre class=" language-bash"><code class="language-bash">upstream laravels <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true"># 通过 IP:Port 连接</span>
    server 127.0.0.1:5200 weight<span class="token operator">=</span>5 max_fails<span class="token operator">=</span>3 fail_timeout<span class="token operator">=</span>30s<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true"># 通过 UnixSocket Stream 连接，小诀窍：将socket文件放在/dev/shm目录下，可获得更好的性能</span>
    <span class="token comment" spellcheck="true">#server unix:/xxxpath/laravel-s-test/storage/laravels.sock weight=5 max_fails=3 fail_timeout=30s;</span>
    <span class="token comment" spellcheck="true">#server 192.168.1.1:5200 weight=3 max_fails=3 fail_timeout=30s;</span>
    <span class="token comment" spellcheck="true">#server 192.168.1.2:5200 backup;</span>
    keepalive 16<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
server <span class="token punctuation">{</span>

        listen       80<span class="token punctuation">;</span>
        server_name  laravels.valsun.cn<span class="token punctuation">;</span>

        root        /data/web/niftyAdmin/public/<span class="token punctuation">;</span>
        error_log   /data/web/niftyAdmin/storage/logs/error.log   error<span class="token punctuation">;</span>
        access_log  /data/web/niftyAdmin/storage/logs/access.log  main<span class="token punctuation">;</span>
        index index.php<span class="token punctuation">;</span>

        location / <span class="token punctuation">{</span>
             try_files <span class="token variable">$uri</span> @laravels<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        location @laravels <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true"># proxy_connect_timeout 60s;</span>
            <span class="token comment" spellcheck="true"># proxy_send_timeout 60s;</span>
            <span class="token comment" spellcheck="true"># proxy_read_timeout 120s;</span>
            proxy_http_version 1.1<span class="token punctuation">;</span>
            proxy_set_header Connection <span class="token string">""</span><span class="token punctuation">;</span>
            proxy_set_header X-Real-IP <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>
            proxy_set_header X-Real-PORT <span class="token variable">$remote_port</span><span class="token punctuation">;</span>
            proxy_set_header X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>
            proxy_set_header Host <span class="token variable">$http_host</span><span class="token punctuation">;</span>
            proxy_set_header Scheme <span class="token variable">$scheme</span><span class="token punctuation">;</span>
            proxy_set_header Server-Protocol <span class="token variable">$server_protocol</span><span class="token punctuation">;</span>
            proxy_set_header Server-Name <span class="token variable">$server_name</span><span class="token punctuation">;</span>
            proxy_set_header Server-Addr <span class="token variable">$server_addr</span><span class="token punctuation">;</span>
            proxy_set_header Server-Port <span class="token variable">$server_port</span><span class="token punctuation">;</span>
            proxy_pass http://laravels<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre>
<h3 id="压测"><a href="#压测" class="headerlink" title="压测"></a>压测</h3><p>PHP 7.0.11 + Laravel5.5<br>服务器配置，就一个小型测试项目在跑，装有一个mysql服务。</p>
<pre class=" language-bash"><code class="language-bash"><span class="token function">top</span> - 11:30:03 up 396 days, 10:08,  2 users,  load average: 0.14, 5.14, 7.21
Tasks: 315 total,   1 running, 297 sleeping,  16 stopped,   1 zombie
Cpu0  <span class="token keyword">:</span> 16.3%us,  4.3%sy,  0.0%ni, 75.4%id,  2.0%wa,  0.0%hi,  1.3%si,  0.7%st
Cpu1  <span class="token keyword">:</span>  1.7%us,  1.7%sy,  0.0%ni, 96.4%id,  0.0%wa,  0.0%hi,  0.0%si,  0.3%st
Cpu2  <span class="token keyword">:</span>  1.0%us,  2.0%sy,  0.0%ni, 96.7%id,  0.3%wa,  0.0%hi,  0.0%si,  0.0%st
Cpu3  <span class="token keyword">:</span>  1.3%us,  1.3%sy,  0.0%ni, 97.4%id,  0.0%wa,  0.0%hi,  0.0%si,  0.0%st
Cpu4  <span class="token keyword">:</span>  1.3%us,  1.3%sy,  0.0%ni, 97.4%id,  0.0%wa,  0.0%hi,  0.0%si,  0.0%st
Cpu5  <span class="token keyword">:</span>  9.3%us,  2.7%sy,  0.0%ni, 88.0%id,  0.0%wa,  0.0%hi,  0.0%si,  0.0%st
Cpu6  <span class="token keyword">:</span>  1.0%us,  3.0%sy,  0.0%ni, 96.0%id,  0.0%wa,  0.0%hi,  0.0%si,  0.0%st
Cpu7  <span class="token keyword">:</span>  0.7%us,  2.3%sy,  0.0%ni, 97.0%id,  0.0%wa,  0.0%hi,  0.0%si,  0.0%st
Mem:  16333892k total, 15396272k used,   937620k free,   191568k buffers
Swap:        0k total,        0k used,        0k free, 10030768k cached

<span class="token punctuation">[</span>root@tracknumber_share niftyAdmin<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># free -m</span>
             total       used       <span class="token function">free</span>     shared    buffers     cached
Mem:         15951      15036        914          0        187       9797
-/+ buffers/cache:       5051      10899
Swap:            0          0          0

</code></pre>
<p>测试都是在本地使用简单的ab测试，目的只是想横向对比 <code>php-fpm + nginx</code>  和 <code>swoole + nginx</code> 的性能</p>
<p><code>./ab -n 5000 -c 500  http://nt.valsun.cn/api/getData</code></p>
<p>逻辑很简单,启用laravel5.5的框架通过api路由直接输出,laravel已经使用上面的优化措施</p>
<pre class=" language-php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">echo</span> <span class="token string">'3123123'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="nginx-php-fpm-测试结果"><a href="#nginx-php-fpm-测试结果" class="headerlink" title="nginx + php-fpm 测试结果"></a>nginx + php-fpm 测试结果</h4><p>压测时服务器的指标</p>
<pre class=" language-bash"><code class="language-bash"><span class="token function">top</span> - 11:41:58 up 396 days, 10:20,  2 users,  load average: 17.20, 12.25, 11.45
</code></pre>
<p>ab压测结果</p>
<pre class=" language-bash"><code class="language-bash">Server Software:        BWS
Server Hostname:        nt.valsun.cn
Server Port:            80

Document Path:          /api/getData
Document Length:        1436 bytes

Concurrency Level:      1000
Time taken <span class="token keyword">for</span> tests:   10.291 seconds
Complete requests:      5000
Failed requests:        954
   <span class="token punctuation">(</span>Connect: 0, Receive: 0, Length: 954, Exceptions: 0<span class="token punctuation">)</span>
Non-2xx responses:      5000
Total transferred:      7339154 bytes
HTML transferred:       5967972 bytes
Requests per second:    485.84 <span class="token punctuation">[</span><span class="token comment" spellcheck="true">#/sec] (mean)</span>
Time per request:       2058.296 <span class="token punctuation">[</span>ms<span class="token punctuation">]</span> <span class="token punctuation">(</span>mean<span class="token punctuation">)</span>
Time per request:       2.058 <span class="token punctuation">[</span>ms<span class="token punctuation">]</span> <span class="token punctuation">(</span>mean, across all concurrent requests<span class="token punctuation">)</span>
Transfer rate:          696.42 <span class="token punctuation">[</span>Kbytes/sec<span class="token punctuation">]</span> received

Connection Times <span class="token punctuation">(</span>ms<span class="token punctuation">)</span>
              min  mean<span class="token punctuation">[</span>+/-sd<span class="token punctuation">]</span> median   max
Connect:        0    2  42.5      1    3004
Processing:   112 1783 1146.6   1527    3988
Waiting:        8 1579 1098.9   1368    3978
Total:        113 1785 1146.8   1528    3989

Percentage of the requests served within a certain <span class="token function">time</span> <span class="token punctuation">(</span>ms<span class="token punctuation">)</span>
  50%   1528
  66%   1751
  75%   2064
  80%   2434
  90%   3946
  95%   3969
  98%   3977
  99%   3978
 100%   3989 <span class="token punctuation">(</span>longest request<span class="token punctuation">)</span>
</code></pre>
<h4 id="nginx-swoole-压测"><a href="#nginx-swoole-压测" class="headerlink" title="nginx + swoole 压测"></a>nginx + swoole 压测</h4><p>压测时服务器的指标</p>
<pre class=" language-bash"><code class="language-bash"><span class="token function">top</span> - 11:43:03 up 399 days, 10:21,  4 users,  load average: 5.31, 2.59, 2.12
</code></pre>
<pre class=" language-bash"><code class="language-bash">./ab  -k -t 30 -c 1000    http://laravels.valsun.cn/api/getData
Benchmarking laravels.valsun.cn <span class="token punctuation">(</span>be patient<span class="token punctuation">)</span>
Completed 5000 requests
Completed 10000 requests
Completed 15000 requests
Completed 20000 requests
Completed 25000 requests
Completed 30000 requests
Completed 35000 requests
Completed 40000 requests
Completed 45000 requests
Completed 50000 requests
Finished 50000 requests


Server Software:        BWS
Server Hostname:        laravels.valsun.cn
Server Port:            80

Document Path:          /api/getData
Document Length:        38 bytes

Concurrency Level:      1000
Time taken <span class="token keyword">for</span> tests:   14.921 seconds
Complete requests:      50000
Failed requests:        1772
   <span class="token punctuation">(</span>Connect: 0, Receive: 0, Length: 1772, Exceptions: 0<span class="token punctuation">)</span>
Non-2xx responses:      1772
Keep-Alive requests:    48228
Total transferred:      13281128 bytes
HTML transferred:       2158712 bytes
Requests per second:    3351.01 <span class="token punctuation">[</span><span class="token comment" spellcheck="true">#/sec] (mean)</span>
Time per request:       298.417 <span class="token punctuation">[</span>ms<span class="token punctuation">]</span> <span class="token punctuation">(</span>mean<span class="token punctuation">)</span>
Time per request:       0.298 <span class="token punctuation">[</span>ms<span class="token punctuation">]</span> <span class="token punctuation">(</span>mean, across all concurrent requests<span class="token punctuation">)</span>
Transfer rate:          869.24 <span class="token punctuation">[</span>Kbytes/sec<span class="token punctuation">]</span> received

Connection Times <span class="token punctuation">(</span>ms<span class="token punctuation">)</span>
              min  mean<span class="token punctuation">[</span>+/-sd<span class="token punctuation">]</span> median   max
Connect:        0    0   0.3      0      11
Processing:     4  284 163.2    248    1243
Waiting:        4  274 142.4    247    1134
Total:          4  284 163.3    248    1243

Percentage of the requests served within a certain <span class="token function">time</span> <span class="token punctuation">(</span>ms<span class="token punctuation">)</span>
  50%    248
  66%    288
  75%    323
  80%    348
  90%    449
  95%    612
  98%    875
  99%    976
 100%   1243 <span class="token punctuation">(</span>longest request<span class="token punctuation">)</span>
</code></pre>
<p>这个采用2种ab测试方法主要是 php-fpm 用-t测试并发太高 request fail的比率就太高了，就是用柔和的方式测试。</p>
<p>从测试结果也看出来了swoole提升的性能很大，而且服务器的负载完全没有起来。</p>
<p>但是用swoole常驻内存需要注意下一些事项。</p>
<h3 id="swoole常驻内存注意事项"><a href="#swoole常驻内存注意事项" class="headerlink" title="swoole常驻内存注意事项"></a>swoole常驻内存注意事项</h3><p><a href="https://github.com/hhxsv5/laravel-s/blob/master/README-CN.md#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9" target="_blank" rel="noopener">laravels的注意事项</a></p>
<ol>
<li>应通过Illuminate\Http\Request对象来获取请求信息 $_ENV是可读取的，$_SERVER是部分可读的，不能使用$_GET、$_POST、$_FILES、$_COOKIE、$_REQUEST、$_SESSION、$GLOBALS</li>
<li>推荐通过返回Illuminate\Http\Response对象来响应请求，兼容echo、vardump()、print_r()，不能使用函数像 dd()、exit()、die()、header()、setcookie()、http_response_code()</li>
<li>各种单例的连接将被常驻内存，建议开启持久连接</li>
<li>你声明的全局、静态变量必须手动清理或重置</li>
<li>无限追加元素到静态或全局变量中，将导致内存爆满</li>
<li>是用swoole优化之后 尽量不适用static 声明静态变量,也没有那个必要,这里有简单的方法去偷懒,就是把laravels.php配置文件中的 max_request降低一点这样它重启的频率就会大一点，以免单进程的内存暴了</li>
<li>单例问题 ,laravel框架到处都用了单例。</li>
</ol>
<ul>
<li>传统FPM下，单例模式的对象的生命周期仅在每次请求中，请求开始=&gt;实例化单例=&gt;请求结束后=&gt;单例对象资源回收。</li>
<li>Swoole Server下，所有单例对象会常驻于内存，这个时候单例对象的生命周期与FPM不同，请求开始=&gt;实例化单例=&gt;请求结束=&gt;单例对象依旧保留，需要开发者自己维护单例的状态</li>
<li>详见laravels文档,作者提供了详细的解决方案主要就是 Session,Passport,JWT的使用</li>
<li>如果要使用laravels，强烈建议先把这个laravels结构熟读于心，并且了解初始larvel的功能,毕竟常驻内存和平常的php-fpm编程还是有很大的不同</li>
</ul>
<ol start="8">
<li>引入laravels 不仅仅是提高了并发，而且可以方便的使用swoole的功能，比如websocket,协程，多进程等</li>
<li>由于larvels是常驻内存，所以每次修改代码之后要看见效果就需要重启./bin/laravels reload，这个作者也提供了解决方案哦 <a href="https://github.com/hhxsv5/laravel-s/blob/master/README-CN.md#%E4%BF%AE%E6%94%B9%E4%BB%A3%E7%A0%81%E5%90%8E%E8%87%AA%E5%8A%A8reload" target="_blank" rel="noopener">自动reload</a></li>
<li>laravels 初步在小型项目使用 ，用户认证包括(session 和jwt) ,Eloquent ORM,路由，Artisan 命令行 ，Blade模板渲染都没有问题。</li>
</ol>

            </div>
            <hr>

            
            <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.88rem;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-large waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fa fa-close"></i></a>
            <h4 class="reward-title">感谢您的认可与支持</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="https://githubio.pek3b.qingstor.com/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="https://githubio.pek3b.qingstor.com/medias/reward/wechat.jpg" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>
            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    <div class="social-share" data-disabled="qzone" data-wechat-qrcode-helper="<p>微信里点“发现”->“扫一扫”二维码便可查看分享。</p>"></div>
    
</div>

<script src="/libs/share/js/social-share.min.js"></script>

            <div class="reprint">
                <p>
                    <span class="reprint-tip">
                        <i class="fa fa-exclamation-circle"></i>&nbsp;&nbsp;转载请注明:
                    </span>
                    <a href="http://wyq2214368.github.io" class="b-link-green">WYQ</a>
                    <i class="fa fa-angle-right fa-lg fa-fw text-color"></i>
                    <a href="/2019/05/14/php/laravel-optimize/" class="b-link-green">使用Swoole提升Laravel的性能</a>
                </p>
            </div>
        </div>
    </div>

    
        <link rel="stylesheet" href="https://cdn.bootcss.com/gitalk/1.5.0/gitalk.min.css">
<link rel="stylesheet" href="/css/my-gitalk.css">

<div class="card gitalk-card" data-aos="fade-up">
    <div id="gitalk-container" class="card-content"></div>
</div>

<script src="https://cdn.bootcss.com/gitalk/1.5.0/gitalk.min.js"></script>
<script>
    let gitalk = new Gitalk({
        clientID: '4fa3700cfe038b2f911e',
        clientSecret: 'fcfb5a7797fa2f21ae2dffa69c4875e5a64d4b64',
        repo: 'wyq2214368.github.io',
        owner: 'wyq2214368',
        admin: "wyq2214368",
        id: '2019-05-14T00-00-00',
        distractionFreeMode: false  // Facebook-like distraction free mode
    });

    gitalk.render('gitalk-container');
</script>
    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6 overflow-policy" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2019/05/21/php/websocket-mini-liao-tian-shi/">
                    <div class="card-image">
                        
                        
                        <img src="https://githubio.pek3b.qingstor.com/medias/featureimages/5.jpg" class="responsive-img" alt="Websokcet 实现mini聊天室">
                        
                        <span class="card-title">Websokcet 实现mini聊天室</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">前端经常需要与服务器进行持续的通讯以保持双方信息的同步，long long ago 我们会使用长轮询的方式来实现比如:
setInterval(function() {
    $.get("/api/getData", function(</div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2019-05-21
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/php/" class="post-category" target="_blank">
                                    php
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/websokcet/" target="_blank">
                        <span class="chip bg-color">websokcet</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6 overflow-policy" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2019/04/29/swoole/coroutine/">
                    <div class="card-image">
                        
                        
                        <img src="https://githubio.pek3b.qingstor.com/medias/featureimages/15.jpg" class="responsive-img" alt="Swoole 协程">
                        
                        <span class="card-title">Swoole 协程</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">Swoole 协程协程可以理解为纯用户态的线程，其通过协作而不是抢占来进行切换。相对于进程或者线程，协程所有的操作都可以在用户态完成，创建和切换的消耗更低。协程主要用于优化IO操作频繁的任务,当然这个IO需要使用异步IO，能够yeild的异</div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2019-04-29
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/PHP/" class="post-category" target="_blank">
                                    PHP
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/swoole/" target="_blank">
                        <span class="chip bg-color">swoole</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>
</div>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="https://cdn.bootcss.com/tocbot/4.7.0/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>
    

</main>


<footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">

            

            
			
                <br>
                
                <span id="busuanzi_container_site_pv">
                    <i class="fa fa-heart-o"></i>
                    本站总访问量 <span id="busuanzi_value_site_pv" class="white-color"></span>
                </span>
                
                
                <span id="busuanzi_container_site_uv">
                    <i class="fa fa-users"></i>
                    次,&nbsp;访客数 <span id="busuanzi_value_site_uv" class="white-color"></span> 人.
                </span>
                
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">





</div>
    </div>
</footer>

<div class="progress-bar"></div>


<!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字" class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="https://githubio.pek3b.qingstor.com/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
<!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


<script src="https://cdn.bootcss.com/materialize/1.0.0/js/materialize.min.js"></script>
<script src="https://cdn.bootcss.com/masonry/4.0.0/masonry.pkgd.min.js"></script>
<script src="https://cdn.bootcss.com/aos/2.3.4/aos.js"></script>
<script src="https://cdn.bootcss.com/scrollprogress/3.0.0/scrollProgress.min.js"></script>
<script src="https://cdn.bootcss.com/lightgallery/1.6.11/js/lightgallery-all.min.js"></script>
<script src="https://githubio.pek3b.qingstor.com/js/matery.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->



    <script src="https://githubio.pek3b.qingstor.com/libs/others/clicklove.js"></script>


    <script async src="https://githubio.pek3b.qingstor.com/libs/others/busuanzi.pure.mini.js"></script>


</body>
</html>